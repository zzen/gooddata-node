<h1>Invite user to multiple projects</h1>

<form style="float: right">
    <div id="users"></div>
    <input type="button" name="remove" value="Remove Selected Users" id="remove" style="display: none">
</form>

<form action="/add" method="post" accept-charset="utf-8" id="projects">

    <h3>Select one or more projects</h3>
    <%- partial('projectOptions', { collection: editableProjects, as: 'project' }) %>

    <!-- <h3>These projects cannot be modified</h3>
    <%- partial('projectItem', { collection: readonlyProjects, as: 'project' }) %> -->

    <h3>Guests to Invite</h3>
    <div>Enter email addresses (separated by comma) to invite</div>
    <textarea name="guests" rows="8" cols="40"></textarea>

    <p><input type="submit" value="Invite Users"></p>
</form>


<script src="js/native-ext.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
    var users = <%- users %>;
    var selectedMode = false;
    $(document).ready(function() {
        
        var findUsers = function(elems) {
            var urls = [], obj = {}, emails = [];
            elems.each(function() {
                var parent = $(this).parents('.project');
                var uri = $(parent).attr('data-project-uri');
                if (urls.indexOf(uri) == -1) urls.push(uri);
            });
            
            urls.forEach(function(url) {
                var urlEmails = users[url].map(function(user) { return '<label><input type="checkbox" name="emails" value="'+user.user.content.email+'">'+user.user.content.email+'</label>'; });
                emails.merge(urlEmails);
            });
            return emails;
        };
        
        $('#projects .project label').mouseover(function() {
            $('#users').html(findUsers($('#projects input:checked').add(this)).join('<br>'));
        });
        
        $('#users').live('label', function() {
            this.click(function() {
                console.log('test');
                if ($('#users input:checked').size() > 0) $('#remove').show();
                else $('#remove').hide();
            });
        });
        
        $('#projects input').change(function() {
            var elems = $('#projects input:checked');
            selectedMode = elems.size();
            var emails = findUsers(elems);
            $('#users').html(emails.join('<br>'));
            console.log($('#users label').size());
        });
    });
</script>